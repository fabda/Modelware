# Download models from various repository

# Get Variables from Modelware configuration file
. $MW_HOME/conf/mw.conf

# Argument checker
if [ $# -eq 0 ]
  then
    echo "Nothing to do ? check help : mw-mod --help "
    exit 1
fi


# Helper
if [ $1 = '-h' ] || [ $1 = '--help' ]
  then

  echo " "
  echo " "
  echo "1) Usage (getfrom) : `basename $0` getfrom gdrive  [URL link]              : download a model from google drive URL"
  echo "............... or : `basename $0` getfrom fromurl [URL link]              : download a model from an URL (not google drive)"
  echo "............... or : `basename $0` getfrom alias   [Model alias name]      : download a model from an URL using its predefined alias"
  echo " "
  echo "2) Usage (alias)   : `basename $0` set alias [Model alias name] [URL link] : set a model alias name from an URL link"
  echo " "
  echo " "
  exit 0
fi

# getter
if [ $1 = "getfrom" ]
  then
    # From Google Drive (with two type of URLs possible)
    if [ $2 = "drive" ]
      then
        echo "Downloading model from Google Drive URL : $3:"
        #Type 1 URL
        ID=`echo $3 | cut -d '/' -f 6`
        if [ -z "$ID" ]
          then
            #Type 2 URL
            ID=`echo "$3" | cut -d '=' -f 2`
        fi
        gdown -O model.zip https://drive.google.com/uc?id=$ID
        unzip -o model.zip -d $MW_HOME/models/
        rm -f model.zip
        exit 1
    fi


    # From URL
    if [ $2 = "url" ]
      then
        echo "Downloading model from URL : $3"
        wget -O model.zip $3
        unzip -o model.zip -d $MW_HOME/models/
        rm -f model.zip
        exit 1
    fi

    # From alias
    if [ $2 = "alias" ]
      then
        if test -f "aliases.repo"
          then
            ALIAS=`cat aliases.repo | grep "$3" | cut -d " " -f 2`
            echo $ALIAS
            echo "Downloading model from alias : $3"
            wget -O model.zip $ALIAS
            unzip -o model.zip -d $MW_HOME/models/
            rm -f model.zip
            exit 1

        else
          echo "No alias has been recorded yet !"
          exit 0
        fi
    fi
fi

#aliasing
if [ $1 = "set" ]
  then
    if [ $2 = "alias" ]
      then
        if test -f "aliases.repo"
          then
            :
        else
          :> "aliases.repo"
        fi

        if [ `cat "$MW_HOME/aliases.repo" | grep $3 | wc -l` -eq 0 ]
          then
            echo $3 $4 >> "$MW_HOME/aliases.repo"
            echo "$3 alias has been added successfully to aliases.repo ! "
            exit 1
        else
          echo "$3 alias is already defined !"
          exit 0
        fi
    fi
fi
